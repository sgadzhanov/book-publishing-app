name: WhatsApp on Vercel Deployment Success

on:
  deployment_status:

permissions:
  contents: read

jobs:
  notify:
    if: >
      github.event.deployment_status.state == 'success' &&
      contains(github.event.deployment_status.target_url, 'book-publishing-app-g2v6')
    runs-on: ubuntu-latest

    steps:
      - name: Debug deployment event (temporary)
        run: |
          echo "State: ${{ github.event.deployment_status.state }}"
          echo "Environment: ${{ github.event.deployment.environment }}"
          echo "URL: ${{ github.event.deployment_status.target_url }}"
          echo "SHA: ${{ github.event.deployment.sha }}"


      - name: Fetch commit message
        id: commit
        run: |
          SHA="${{ github.event.deployment.sha }}"

          MESSAGE=$(curl -s \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          -H "Accept: application/vnd.github+json" \
          https://api.github.com/repos/${{ github.repository }}/commits/$SHA \
          | jq -r '.commit.message')

          TITLE=$(echo "$MESSAGE" | head -n 1)
          BULLETS=$(echo "$MESSAGE" | grep '^- ' || echo "- $TITLE")

          echo "bullets<<EOF" >> $GITHUB_OUTPUT
          echo "$BULLETS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send WhatsApp message via Twilio
        run: |
          curl --fail -X POST https://api.twilio.com/2010-04-01/Accounts/${{ secrets.TWILIO_ACCOUNT_SID }}/Messages.json \
          --data-urlencode "From=${{ secrets.TWILIO_WHATSAPP_FROM }}" \
          --data-urlencode "To=${{ secrets.TWILIO_WHATSAPP_TO }}" \
          --data-urlencode "Body=‚úÖ Update deployed successfully

          ‚ô•Ô∏è –•–µ–π, –ú–∏–º–∏! –¢—É–∫ –∏ –ø–æ —Ç–æ–∑–∏ –Ω–∞—á–∏–Ω —â–µ —Ç–∏ –∏–∑–ø—Ä–∞—â–∞–º –∏–∑–≤–µ—Å—Ç–∏—è –ø—Ä–∏ –≤—Å—è–∫–æ –æ–±–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ —Å–∞–π—Ç–∞!

          üîó App:
          https://book-publishing-app-g2v6.vercel.app/

          üìù What changed:
          ${{ steps.commit.outputs.bullets }}" \
              -u "${{ secrets.TWILIO_ACCOUNT_SID }}:${{ secrets.TWILIO_AUTH_TOKEN }}"
